<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamEAST 고객만족도 보고서</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .satisfaction-bar-container {
            background-color: #e5e7eb; /* Lighter gray for the background of the bar */
            border-radius: 9999px; /* Fully rounded corners */
            height: 1rem; /* Height of the bar */
            overflow: hidden; /* Ensure content stays within rounded corners */
        }
        .satisfaction-bar {
            height: 100%;
            border-radius: 9999px; /* Fully rounded corners */
            transition: width 0.5s ease-in-out; /* Smooth transition for width changes */
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-4">TeamEAST 상반기 고객만족도 응답 보고서</h1>
        <p id="total-responses" class="text-lg text-center text-gray-600 mb-2"></p>
        <p id="overall-satisfaction-score" class="text-xl font-bold text-center text-blue-600 mb-8"></p>

        <div id="employee-satisfaction-data" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p class="text-center text-gray-600 col-span-full">데이터를 불러오는 중입니다...</p>
        </div>
    </div>

    <div id="voc-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                <h2 id="modal-employee-name" class="text-2xl font-bold text-gray-800"></h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            <div id="voc-details-content" class="text-gray-700">
                </div>
        </div>
    </div>

    <script>
        // CSV 데이터 변수는 삭제됨
        let allSurveyResponses = []; // 모든 설문 응답을 저장할 배열

        /**
         * CSV 데이터를 파싱하고 직원별 만족도 데이터 및 전체 응답을 계산합니다.
         */
        function parseCsvData(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length < 2) {
                console.error("CSV 데이터가 헤더 또는 데이터 행을 포함하지 않습니다.");
                return { employeeStats: {}, allResponses: [], totalResponsesCount: 0, overallTeamSatisfaction: 0 };
            }

            const headers = lines[0].split(',');
            const employeeNameColIndex = headers.indexOf('서비스 담당자');
            const satisfactionRateColIndex = headers.indexOf('General Satisfaction Rate');

            if (employeeNameColIndex === -1 || satisfactionRateColIndex === -1) {
                console.error("필수 열('서비스 담당자' 또는 'General Satisfaction Rate')을 찾을 수 없습니다.");
                return { employeeStats: {}, allResponses: [], totalResponsesCount: 0, overallTeamSatisfaction: 0 };
            }

            const employeeData = {};
            const responses = [];
            let validResponseCount = 0;
            let totalTeamSatisfactionSum = 0;

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length < headers.length || row.every(cell => cell.trim() === '')) {
                    continue;
                }

                const employeeName = row[employeeNameColIndex]?.trim();
                const satisfactionRateStr = row[satisfactionRateColIndex]?.trim();
                const satisfactionRate = parseFloat(satisfactionRateStr);

                const rowObject = {};
                headers.forEach((header, index) => {
                    rowObject[header.trim()] = row[index]?.trim() || '';
                });
                responses.push(rowObject);

                if (employeeName && satisfactionRateStr && !isNaN(satisfactionRate)) {
                    if (!employeeData[employeeName]) {
                        employeeData[employeeName] = { totalSatisfaction: 0, count: 0 };
                    }
                    employeeData[employeeName].totalSatisfaction += satisfactionRate;
                    employeeData[employeeName].count += 1;
                    totalTeamSatisfactionSum += satisfactionRate;
                    validResponseCount++;
                } else {
                    let reason = [];
                    if (!employeeName) reason.push('서비스 담당자 누락');
                    if (!satisfactionRateStr) reason.push('General Satisfaction Rate 문자열 누락');
                    if (isNaN(satisfactionRate)) reason.push('General Satisfaction Rate 유효하지 않은 숫자');
                    console.warn(`행 ${i+1} 건너김 (사유: ${reason.join(', ')}): "${lines[i]}"`);
                }
            }

            const resultStats = {};
            for (const name in employeeData) {
                if (employeeData[name].count > 0) {
                    resultStats[name] = {
                        averageSatisfaction: (employeeData[name].totalSatisfaction / employeeData[name].count).toFixed(2),
                        count: employeeData[name].count
                    };
                }
            }

            const overallTeamSatisfaction = validResponseCount > 0 ? (totalTeamSatisfactionSum / validResponseCount).toFixed(2) : 0;

            return {
                employeeStats: resultStats,
                allResponses: responses,
                totalResponsesCount: validResponseCount,
                overallTeamSatisfaction: parseFloat(overallTeamSatisfaction)
            };
        }

        /**
         * 계산된 직원별 만족도 데이터를 웹페이지에 렌더링합니다.
         */
        function renderSatisfactionData(data, totalCount, overallScore) {
            const container = document.getElementById('employee-satisfaction-data');
            const totalResponsesElement = document.getElementById('total-responses');
            const overallSatisfactionElement = document.getElementById('overall-satisfaction-score');
            container.innerHTML = ''; 

            totalResponsesElement.textContent = `팀 전체 응답 수: ${totalCount}건`;
            overallSatisfactionElement.textContent = `팀 전체 고객 만족도 점수: ${overallScore}%`;

            if (Object.keys(data).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-600 col-span-full">표시할 데이터가 없습니다.</p>';
                return;
            }

            const sortedEmployees = Object.entries(data).sort(([, a], [, b]) => b.averageSatisfaction - a.averageSatisfaction);

            sortedEmployees.forEach(([employeeName, employeeStats]) => {
                const average = parseFloat(employeeStats.averageSatisfaction);
                const count = employeeStats.count;

                let barColorClass = average >= 90 ? 'bg-green-500' : average >= 70 ? 'bg-yellow-500' : 'bg-red-500';

                const cardHtml = `
                    <div class="bg-white rounded-lg shadow-md p-5 border border-gray-200 cursor-pointer hover:shadow-xl transition-shadow duration-200" onclick="showVocDetails('${employeeName}')">
                        <h2 class="text-xl font-semibold text-gray-700 mb-2">${employeeName}</h2>
                        <p class="text-gray-600 mb-4">총 응답 수: ${count}건</p>
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">평균 만족도:</span>
                                <span class="text-lg font-bold text-gray-800">${average}%</span>
                            </div>
                            <div class="satisfaction-bar-container">
                                <div class="satisfaction-bar ${barColorClass}" style="width: ${average}%;"></div>
                            </div>
                        </div>
                        <p class="text-center text-blue-500 text-sm mt-4">VOC 상세 보기</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        /**
         * 특정 직원의 VOC 상세 내역을 모달로 표시합니다.
         */
        function showVocDetails(employeeName) {
            const modal = document.getElementById('voc-modal');
            const modalEmployeeName = document.getElementById('modal-employee-name');
            const vocDetailsContent = document.getElementById('voc-details-content');

            modalEmployeeName.textContent = `${employeeName} 고객 VOC 상세 내역`;
            vocDetailsContent.innerHTML = '';

            const employeeVoc = allSurveyResponses.filter(response => response['서비스 담당자'] === employeeName);

            if (employeeVoc.length === 0) {
                vocDetailsContent.innerHTML = '<p class="text-gray-600">해당 직원에 대한 VOC가 없습니다.</p>';
            } else {
                employeeVoc.forEach((voc) => {
                    const customerInfo = voc['Customer info'] || '고객 정보 없음';
                    const vocItem = `
                        <div class="border-b border-gray-100 py-3 last:border-b-0">
                            <p class="text-sm text-gray-500 mb-1"><strong>고객 정보:</strong> ${customerInfo}</p>
                            ${voc['어떤 문제가 해결되지 않았나요?'] ? `<p><strong>해결되지 않은 문제:</strong> ${voc['어떤 문제가 해결되지 않았나요?']}</p>` : ''}
                            ${voc['얼마나 신속한 방문이 적정할지?'] ? `<p><strong>적정 방문 신속성:</strong> ${voc['얼마나 신속한 방문이 적정할지?']}</p>` : ''}
                            ${voc['응대직원의 어떤 점이 불편했는지?'] ? `<p><strong>응대 불편 사항:</strong> ${voc['응대직원의 어떤 점이 불편했는지?']}</p>` : ''}
                            ${voc['설명에서 어떤 점이 부족했는지?'] ? `<p><strong>설명 부족 사항:</strong> ${voc['설명에서 어떤 점이 부족했는지?']}</p>` : ''}
                            ${voc['전반적 서비스에서 개선되어야 할 부분은?'] ? `<p><strong>개선 필요 사항:</strong> ${voc['전반적 서비스에서 개선되어야 할 부분은?']}</p>` : ''}
                            ${voc['General Satisfaction Rate'] !== undefined && voc['General Satisfaction Rate'] !== '' ? `<p><strong>전반적 만족도:</strong> ${voc['General Satisfaction Rate']}%</p>` : ''}
                        </div>
                    `;
                    vocDetailsContent.insertAdjacentHTML('beforeend', vocItem);
                });
            }
            modal.classList.add('open');
        }
        
        // 모달 닫기 기능
        document.getElementById('close-modal').addEventListener('click', () => document.getElementById('voc-modal').classList.remove('open'));
        document.getElementById('voc-modal').addEventListener('click', (event) => {
            if (event.target === event.currentTarget) {
                document.getElementById('voc-modal').classList.remove('open');
            }
        });

        // 페이지 로드 시 외부 CSV 파일을 불러와서 데이터 처리 및 렌더링
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('csv/CustomerSurveySatisfaction.csv');
                if (!response.ok) {
                    throw new Error(`파일 로딩 실패 (HTTP 상태 코드: ${response.status})`);
                }
                const csvData = await response.text();

                // 인코딩 문제 방지를 위해, 만약 파일이 UTF-8-BOM으로 저장되었을 경우 BOM 제거
                const cleanCsvData = csvData.startsWith('\uFEFF') ? csvData.substring(1) : csvData;

                const { employeeStats, allResponses, totalResponsesCount, overallTeamSatisfaction } = parseCsvData(cleanCsvData);
                allSurveyResponses = allResponses;
                renderSatisfactionData(employeeStats, totalResponsesCount, overallTeamSatisfaction);

            } catch (error) {
                console.error("데이터를 불러오는 중 오류가 발생했습니다:", error);
                const container = document.getElementById('employee-satisfaction-data');
                container.innerHTML = `<p class="text-center text-red-600 col-span-full font-semibold">데이터 로딩에 실패했습니다. 파일 경로('csv/CustomerSurveySatisfaction.csv')와 파일 인코딩(UTF-8)을 확인해주세요.</p>`;
            }
        });
    </script>
</body>
</html>
