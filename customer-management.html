<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025년도 설치일 기준 6개월 경과 장비 내역</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb; /* Border color for grid */
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .calendar-day, .calendar-header {
            background-color: #ffffff;
            padding: 0.75rem;
            text-align: center;
            border-radius: 0.25rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to the top */
            min-height: 100px; /* Ensure consistent height for days, increased for content */
            overflow: hidden; /* Hide overflowing text */
        }
        .calendar-header {
            font-weight: 600;
            background-color: #e0e7ff; /* Light blue for headers */
        }
        .calendar-day.current-month {
            color: #374151; /* Darker text for current month */
        }
        .calendar-day.other-month {
            color: #9ca3af; /* Lighter text for other months */
        }
        .calendar-day.has-event {
            background-color: #bfdbfe; /* Light blue for days with events */
            cursor: pointer;
            position: relative;
        }
        .calendar-day.has-event:hover {
            background-color: #93c5fd; /* Darker blue on hover */
        }
        .event-summary {
            font-size: 0.75rem; /* Smaller font for event details */
            line-height: 1.2;
            text-align: center; /* Center text in summary */
            width: 100%;
            margin-top: 0.5rem;
            color: #3b82f6; /* Blue text for event summary */
        }
        .event-summary p {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.5rem;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .filter-button {
            @apply px-3 py-1 rounded-md text-sm font-medium;
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
            transition: background-color 0.2s ease-in-out;
        }
        .filter-button.active {
            @apply bg-blue-500 text-white hover:bg-blue-600;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">2025년도 설치일 기준 6개월 경과 장비 내역</h1>

        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 ease-in-out">이전 달</button>
            <h2 id="currentMonthYear" class="text-2xl font-semibold text-gray-700"></h2>
            <button id="nextMonth" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 ease-in-out">다음 달</button>
        </div>

        <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">담당자 필터:</h3>
            <div id="assigneeFilters" class="flex flex-wrap gap-2">
                <button class="filter-button active" data-filter-type="assignee" data-filter-value="all">전체</button>
                </div>
        </div>

        <div id="calendar" class="calendar-grid">
            <div class="calendar-header">일</div>
            <div class="calendar-header">월</div>
            <div class="calendar-header">화</div>
            <div class="calendar-header">수</div>
            <div class="calendar-header">목</div>
            <div class="calendar-header">금</div>
            <div class="calendar-header">토</div>
            </div>

        <div class="mt-8">
            <h3 id="eventListTitle" class="text-2xl font-bold text-gray-800 mb-4">전체 유지보수 일정 목록</h3>
            <div id="eventList" class="space-y-4">
                <p class="text-gray-500" id="noEventsMessage">유지보수 일정을 불러오는 중입니다...</p>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalDate" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <div id="modalEvents" class="space-y-2">
                </div>
            <p id="noModalEventsMessage" class="text-gray-500 hidden">이 날짜에는 유지보수 일정이 없습니다.</p>
        </div>
    </div>

    <script>
        // CSV 데이터 변수 삭제

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let allEvents = [];
        let filteredEvents = [];
        let activeAssigneeFilter = 'all';

        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const eventListEl = document.getElementById('eventList');
        const noEventsMessageEl = document.getElementById('noEventsMessage');
        const assigneeFiltersEl = document.getElementById('assigneeFilters');
        const eventListTitleEl = document.getElementById('eventListTitle');

        const eventModal = document.getElementById('eventModal');
        const modalDateEl = document.getElementById('modalDate');
        const modalEventsEl = document.getElementById('modalEvents');
        const noModalEventsMessageEl = document.getElementById('noModalEventsMessage');
        const closeButton = document.querySelector('.close-button');

        function parseCSV(csv) {
            const lines = csv.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            const dataRows = lines.slice(1);

            const installationDateIndex = headers.indexOf('설치일');
            const productNameIndex = headers.indexOf('제품명: 제품 이름');
            const customerNameIndex = headers.indexOf('고객명: 고객 이름');
            const 담당자Index = headers.indexOf('담당자: 전체 이름');

            if (installationDateIndex === -1 || productNameIndex === -1 || customerNameIndex === -1 || 담당자Index === -1) {
                console.error("필수 컬럼(설치일, 제품명: 제품 이름, 고객명: 고객 이름, 담당자: 전체 이름)을 찾을 수 없습니다.");
                return [];
            }

            const parsedEvents = [];
            dataRows.forEach(row => {
                const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const installationDateStr = values[installationDateIndex]?.trim();
                const productName = values[productNameIndex]?.trim().replace(/^"|"$/g, '');
                const customerName = values[customerNameIndex]?.trim().replace(/^"|"$/g, '');
                const 담당자 = values[담당자Index]?.trim();

                if (installationDateStr && productName && customerName && 담당자) {
                    const installDate = new Date(installationDateStr);
                    if (!isNaN(installDate.getTime())) {
                        const maintenanceDate = new Date(installDate);
                        maintenanceDate.setMonth(maintenanceDate.getMonth() + 6);

                        parsedEvents.push({
                            installDate: installationDateStr,
                            maintenanceDate: maintenanceDate.toISOString().split('T')[0],
                            productName: productName,
                            customerName: customerName,
                            담당자: 담당자
                        });
                    }
                }
            });
            return parsedEvents;
        }
        
        function applyFilters() {
            let tempEvents = [...allEvents];
            if (activeAssigneeFilter !== 'all') {
                tempEvents = tempEvents.filter(event => event.담당자 === activeAssigneeFilter);
            }
            filteredEvents = tempEvents;
            renderCalendar();
            displayEventList();
        }

        function renderCalendar() {
            calendarEl.innerHTML = `<div class="calendar-header">일</div><div class="calendar-header">월</div><div class="calendar-header">화</div><div class="calendar-header">수</div><div class="calendar-header">목</div><div class="calendar-header">금</div><div class="calendar-header">토</div>`;
            currentMonthYearEl.textContent = `${currentYear}년 ${currentMonth + 1}월`;
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'other-month', 'opacity-50');
                calendarEl.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('calendar-day', 'current-month', 'rounded-md', 'relative');
                dayEl.textContent = day;
                dayEl.dataset.date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const eventsOnThisDay = filteredEvents.filter(event => event.maintenanceDate === dayEl.dataset.date);
                if (eventsOnThisDay.length > 0) {
                    dayEl.classList.add('has-event');
                    const eventSummaryDiv = document.createElement('div');
                    eventSummaryDiv.classList.add('event-summary');
                    eventSummaryDiv.innerHTML = `<p>${eventsOnThisDay.length}건</p>`;
                    dayEl.appendChild(eventSummaryDiv);
                    dayEl.addEventListener('click', () => openModal(dayEl.dataset.date, eventsOnThisDay));
                }
                calendarEl.appendChild(dayEl);
            }
        }

        function displayEventList() {
            eventListEl.innerHTML = '';
            const eventsForCurrentMonth = filteredEvents.filter(event => {
                const maintenanceDate = new Date(event.maintenanceDate);
                return maintenanceDate.getFullYear() === currentYear && maintenanceDate.getMonth() === currentMonth;
            });

            let headerText = `${currentYear}년 ${currentMonth + 1}월 유지보수 일정 목록`;
            if (activeAssigneeFilter !== 'all') {
                headerText = `${currentYear}년 ${currentMonth + 1}월 유지보수 일정 (${activeAssigneeFilter})`;
            }
            eventListTitleEl.textContent = headerText;

            if (eventsForCurrentMonth.length === 0) {
                noEventsMessageEl.classList.remove('hidden');
                noEventsMessageEl.textContent = "현재 달에 필터링된 유지보수 일정이 없습니다.";
                return;
            }
            noEventsMessageEl.classList.add('hidden');

            const sortedEvents = [...eventsForCurrentMonth].sort((a, b) => new Date(a.maintenanceDate) - new Date(b.maintenanceDate));
            const groupedEvents = sortedEvents.reduce((acc, event) => {
                if (!acc[event.담당자]) acc[event.담당자] = [];
                acc[event.담당자].push(event);
                return acc;
            }, {});

            for (const 담당자 in groupedEvents) {
                const 담당자Div = document.createElement('div');
                담당자Div.classList.add('bg-blue-50', 'p-4', 'rounded-md', 'shadow-sm');
                담당자Div.innerHTML = `<h4 class="text-lg font-semibold text-blue-800 mb-2">${담당자}</h4>`;
                const ul = document.createElement('ul');
                ul.classList.add('list-disc', 'list-inside', 'text-gray-700');
                groupedEvents[담당자].forEach(event => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="font-medium">${event.maintenanceDate}</span>: ${event.customerName} - ${event.productName} (설치일: ${event.installDate})`;
                    ul.appendChild(li);
                });
                담당자Div.appendChild(ul);
                eventListEl.appendChild(담당자Div);
            }
        }

        function openModal(date, dailyEvents) {
            modalDateEl.textContent = `${date} 유지보수 일정`;
            modalEventsEl.innerHTML = '';
            if (dailyEvents.length > 0) {
                noModalEventsMessageEl.classList.add('hidden');
                dailyEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.classList.add('bg-gray-100', 'p-3', 'rounded-md');
                    eventDiv.innerHTML = `<p><span class="font-semibold">고객명:</span> ${event.customerName}</p><p><span class="font-semibold">제품명:</span> ${event.productName}</p><p><span class="font-semibold">담당자:</span> ${event.담당자}</p><p><span class="font-semibold">설치일:</span> ${event.installDate}</p>`;
                    modalEventsEl.appendChild(eventDiv);
                });
            } else {
                noModalEventsMessageEl.classList.remove('hidden');
            }
            eventModal.style.display = 'flex';
        }

        function closeModal() { eventModal.style.display = 'none'; }
        function populateAssigneeFilters() {
            const uniqueAssignees = [...new Set(allEvents.map(event => event.담당자))].sort();
            uniqueAssignees.forEach(assignee => {
                const button = document.createElement('button');
                button.className = 'filter-button';
                button.dataset.filterType = 'assignee';
                button.dataset.filterValue = assignee;
                button.textContent = assignee;
                assigneeFiltersEl.appendChild(button);
            });
        }

        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            applyFilters();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            applyFilters();
        });

        function handleFilterClick(event) {
            const button = event.target;
            if (!button.matches('.filter-button')) return;
            const filterType = button.dataset.filterType;
            const filterValue = button.dataset.filterValue;
            document.querySelectorAll(`.filter-button[data-filter-type="${filterType}"]`).forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            if (filterType === 'assignee') { activeAssigneeFilter = filterValue; }
            applyFilters();
        }

        assigneeFiltersEl.addEventListener('click', handleFilterClick);
        closeButton.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => { if (event.target === eventModal) closeModal(); });

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('csv/customer-management.csv');
                if (!response.ok) throw new Error(`파일 로딩 실패 (HTTP 상태: ${response.status})`);
                
                const csvText = await response.text();
                // UTF-8-BOM 제거
                const cleanCsvText = csvText.startsWith('\uFEFF') ? csvText.substring(1) : csvText;
                
                allEvents = parseCSV(cleanCsvText);
                populateAssigneeFilters();
                applyFilters();
            } catch (error) {
                console.error("초기화 오류:", error);
                noEventsMessageEl.textContent = `오류: 데이터를 불러올 수 없습니다. 파일 경로와 인코딩(UTF-8)을 확인하세요.`;
                noEventsMessageEl.classList.add('text-red-600', 'font-semibold');
            }
        });

        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>

